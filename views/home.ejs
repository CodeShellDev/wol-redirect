<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<script type="module">
			import { applyInitialTheme } from "/js/theme.js"
			applyInitialTheme()
		</script>

		<link rel="stylesheet" href="style/theme.css" />
		<link rel="stylesheet" href="style/default.css" />
		<link rel="stylesheet" href="style/user.css" />

		<title>Redirect Page</title>
	</head>
	<body>
		<div class="bg-pattern"></div>

		<div class="container">
			<div class="top-row">
				<div class="spinner" id="spin"></div>
				<div class="line" id="hide"></div>
			</div>

			<div class="middle-row">
				<h1 id="title">Starting Service</h1>
				<h3 id="subtitle">Initializing startup...</h3>
			</div>

			<div class="bottom-row">
				<p id="output"></p>
			</div>
		</div>

		<button class="theme-toggle" type="button">
			<span class="sun" aria-hidden="true">‚òÄÔ∏è</span>
			<span class="moon" aria-hidden="true">üåô</span>
		</button>

		<div class="user">
			<div class="profile"></div>
		</div>

		<script type="module">
			import { startWoLProcess } from "/js/wol.js"
			import { setUser } from "/js/user.js"
			import { initToggle } from "/js/theme.js"

			const userData = {
				name: "<%= user.name %>",
				email: "<%= user.email %>",
				locale: "<%= user.locale %>",
			}

			const serviceUrl = "<%= serviceUrl %>"
			const serviceURL = new URL(serviceUrl)

			const output = document.getElementById("output")

			const title = document.getElementById("title")
			const subtitle = document.getElementById("subtitle")

			function changeAnimation(id, newId) {
				const element = document.getElementById(id)
				if (element) element.id = newId
			}

			function handleError({ host = "Service", msg = "" } = {}) {
				msg = msg.trim()

				if (msg === "") {
					msg = `${host} seems to be unreachable`
				}

				setTimeout(() => {
					changeAnimation("spin", "cross-line")
					changeAnimation("hide", "add-line")

					title.textContent = `Something went wrong`
					subtitle.textContent = msg
				}, 250)
			}

			function handleSubtitle(msg) {
				subtitle.textContent = msg
			}

			function handleOutput(msg) {
				output.textContent += msg + "\n"
			}

			initToggle()

			setUser(userData)

			const onload = () => {
				startWoLProcess({
					outputHandler: handleOutput,
					errorHandler: (msg) => {
						handleError({
							msg: msg,
							host: serviceURL.hostname,
						})
					},
					onwsopen: () => {
						handleSubtitle("Starting process...")
						handleOutput("WebSocket connected.")
					},
					onsuccess: (ws, msg) => {
						if (msg.url !== serviceUrl) {
							handleOutput()
							ws.close()
							handleError({
								msg: "Service URL was modified",
							})
						} else {
							handleOutput("Service is online! Redirecting...")
							ws.close()
							setTimeout(() => {
								window.location.href = msg.url
							}, 250)
						}
					},
				})
			}

			window.addEventListener("DOMContentLoaded", onload)
		</script>
	</body>
</html>
