<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<base href="<%= basePath %>/" />

		<link rel="stylesheet" href="style/theme.css" />
		<link rel="stylesheet" href="style/default.css" />
		<link rel="stylesheet" href="style/user.css" />

		<script type="module">
			import { applyInitialTheme } from "./js/theme.js"
			applyInitialTheme()
		</script>

		<title>Redirect Page</title>
	</head>
	<body>
		<div class="bg-pattern"></div>

		<div class="container">
			<div class="top-row">
				<div class="spinner" id="spin"></div>
				<div class="line" id="hide"></div>
			</div>

			<div class="middle-row">
				<h1 id="title">Starting Service</h1>
				<h3 id="subtitle">Waiting before initializing process</h3>
			</div>

			<div class="bottom-row">
				<p id="output"></p>
			</div>
		</div>

		<button class="theme-toggle" type="button">
			<svg
				id="sun"
				xmlns="http://www.w3.org/2000/svg"
				width="24"
				height="24"
				fill="none"
				stroke="currentColor"
				stroke-linecap="round"
				stroke-linejoin="round"
				stroke-width="1.8"
				data-attribution="cc0-icons"
				viewBox="0 0 24 24"
			>
				<path
					d="m4.91 19.052 1.773-1.763M17.317 6.71l1.773-1.762m-.038 14.142-1.763-1.773M6.71 6.683 4.949 4.91M12 22v-2.5m0-15V2m10 10h-2.5m-15 0H2m10 4.5a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9Z"
				/>
			</svg>
			<svg
				id="moon"
				xmlns="http://www.w3.org/2000/svg"
				width="24"
				height="24"
				fill="none"
				stroke="currentColor"
				stroke-linecap="round"
				stroke-linejoin="round"
				stroke-width="1.8"
				data-attribution="cc0-icons"
				viewBox="0 0 24 24"
			>
				<path
					d="M2.65 13.717c.94 5.44 6.082 9.081 11.482 8.133 3.385-.595 6.07-2.853 7.368-5.795a8.206 8.206 0 0 1-3.863 1.796c-4.5.79-8.784-2.244-9.568-6.777-.668-3.859 1.415-7.56 4.825-9.063a9.888 9.888 0 0 0-2.172.14c-5.4.948-9.014 6.127-8.073 11.566Z"
				/>
			</svg>
		</button>

		<div class="user">
			<div class="profile"></div>
		</div>

		<script type="module">
			import { startWoLProcess } from "./js/wol.js"
			import { setUser } from "./js/user.js"
			import { initToggle } from "./js/theme.js"

			const userData = {
				name: "<%= user.name %>",
				email: "<%= user.email %>",
				locale: "<%= user.locale %>",
			}

			const serviceUrl = "<%= serviceUrl %>"
			const serviceURL = new URL(serviceUrl)

			const output = document.getElementById("output")

			const title = document.getElementById("title")
			const subtitle = document.getElementById("subtitle")

			function changeAnimation(id, newId) {
				const element = document.getElementById(id)
				if (element) element.id = newId
			}

			function handleError({ host = "Service", msg = "" } = {}) {
				msg = msg.trim()

				if (msg === "") {
					msg = `${host} seems to be unreachable`
				}

				setTimeout(() => {
					changeAnimation("spin", "cross-line")
					changeAnimation("hide", "add-line")

					title.textContent = `Something went wrong`
					subtitle.textContent = msg
				}, 250)
			}

			function handleSubtitle(msg) {
				subtitle.textContent = msg
			}

			function handleOutput(msg) {
				output.textContent += msg + "\n"
			}

			initToggle()

			setUser(userData)

			const onload = () => {
				handleOutput("Initiliazing process...")
				startWoLProcess({
					outputHandler: handleOutput,
					errorHandler: (msg) => {
						handleError({
							msg: msg,
							host: serviceURL.hostname,
						})
					},
					onwsopen: () => {
						handleSubtitle("Starting process...")
						handleOutput("WebSocket connected")
					},
					onsuccess: (ws, msg) => {
						if (msg.url !== serviceUrl) {
							handleOutput()
							ws.close()
							handleError({
								msg: "Service URL was modified",
							})
						} else {
							handleOutput("Service is online! Redirecting...")
							ws.close()
							setTimeout(() => {
								window.location.href = msg.url
							}, 250)
						}
					},
					endpoint: `${document.baseURI}/start`,
				})
			}

			const waitBeforeProcess = 2 * 1000

			window.addEventListener("DOMContentLoaded", () => {
				const timer = setTimeout(() => {
					if (!document.hidden) {
						onload()
					}
				}, waitBeforeProcess)

				window.addEventListener("beforeunload", () => clearTimeout(timer))
			})
		</script>
	</body>
</html>
